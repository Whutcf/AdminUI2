<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
    <!-- Google Chrome Frame也可以让IE用上Chrome的引擎: -->
    <meta name="renderer" content="webkit">
    <!--国产浏览器高速模式-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="穷在闹市"/>
    <!-- 作者 -->
    <meta name="revised" content="穷在闹市.v3, 2019/05/01"/>
    <!-- 定义页面的最新版本 -->
    <meta name="description" content="网站简介"/>
    <!-- 网站简介 -->
    <meta name="keywords" content="搜索关键字，以半角英文逗号隔开"/>
    <title>国外疫情</title>

    <!-- 公共样式 开始 -->
    <link rel="stylesheet" type="text/css" href="../../css/base.css">
    <link rel="stylesheet" type="text/css" href="../../css/iconfont.css">
    <script type="text/javascript" src="../../framework/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
    <script type="text/javascript" src="../../layui/layui.js"></script>
    <!-- 滚动条插件 -->
    <link rel="stylesheet" type="text/css" href="../../css/jquery.mCustomScrollbar.css">
    <script src="../../framework/jquery-ui-1.10.4.min.js"></script>
    <script src="../../framework/jquery.mousewheel.min.js"></script>
    <script src="../../framework/jquery.mCustomScrollbar.min.js"></script>
    <script src="../../framework/cframe.js"></script><!-- 仅供所有子页面使用 -->
    <!-- 公共样式 结束 -->

    <script type="text/javascript" src="../../../static/framework/echarts.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/reportForm.css">
</head>

<body>
<div class="cBody">
    <!-- 表头工具栏-->
    <form class="layui-form layui-fluid" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">联动筛选</label>
            <div class="layui-input-inline">
                <select id="continents" lay-filter="continentsFilter" lay-search>
                    <option value="">请选择或搜索大洲</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="provinceName" lay-search>
                    <option value="">请选择或搜索国家</option>
                </select>
            </div>
            <div class="layui-inline">
                <a class="layui-btn" id="search_submit" data-type="reload" lay-filter="reload_search_submit">查询</a>
                <a class="layui-btn" id="searchResetBtn" data-type="reload" lay-filter="searchResetBtn">重置</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn" id="refresh" lay-filter="refresh">刷新实时数据</a>
            </div>
        </div>
    </form>
    <!-- table -->
    <div style="width: 100%; height: 300px;">
        <table class="layui-hide-sm" id="foreignStatistics" lay-skin="line" lay-filter="foreignStatic"></table>
    </div>
    <!-- echarts参照  -->
    <div style="width: 100%; height: 400px; margin-top :220px">
        <form class="layui-form" action="">
            <div class="layui-input-inline">
                <select name="reportType" id="reportType" lay-filter="reportType">
                    <option value="订单数量">订单数量</option>
                    <option value="退货单数">退货单数</option>
                    <option value="订货金额">订货金额</option>
                    <option value="退货金额">退货金额</option>
                    <option value="金额合计">金额合计</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <a class="pressBut active" onclick="refreshData([82, 2, 91, 34, 10, 120, 20],this)">按天</a>
                <a class="pressBut" onclick="refreshData([10, 21, 1, 134, 210, 520, 420],this)">按周</a>
                <a class="pressBut" onclick="refreshData([82, 2, 91, 34, 10, 120, 20],this)">按月</a>
            </div>
            <div class="changeRate">
                <div class="layui-col-md6 left">115.20</div>
                <div class="layui-col-md6 right">
                    <!--上升-->
                    <!--<span class="data up">-99.42%<i class="iconfont icon-xiangshangjiantoucuxiao"></i></span>-->
                    <!--下降-->
                    <span class="data">-99.42%<i class="iconfont icon-xiangxiajiantoucuxiao"></i></span>
                    <span class="text">相比上周期</span>
                </div>
            </div>
            <div id="myReport" style="width: 100%; height: 400px;"></div>
            <script src="../../framework/echarts.min.js"></script>
            <script type="text/javascript">
                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(document.getElementById('myReport'));

                // 指定图表的配置项和数据
                var option = {
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: ['2018-03-01', '2018-03-02', '2018-03-03', '2018-03-04', '2018-03-05', '2018-03-06', '2018-03-07']
                    },
                    yAxis: {
                        type: 'value'
                    },
                    grid: {
                        top: 20,
                        bottom: 20,
                        left: 50,
                        right: 50
                    },
                    series: [{
                        data: [820, 932, 901, 934, 1290, 1330, 1320],
                        type: 'line',
                        areaStyle: {}
                    }]
                };
                myChart.setOption(option);

                function refreshData(data, _this) {
                    $(_this).addClass("active");
                    $(_this).siblings().removeClass("active");
                    if (!myChart) {
                        return;
                    }

                    //更新数据
                    var option = myChart.getOption();
                    option.series[0].data = data;
                    myChart.setOption(option);
                }
            </script>
        </form>
    </div>
</div>
</body>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="detail">查看历史数据</a>
</script>
<script>
    layui.use(['table', 'form', 'layer'], function () {
        const table = layui.table
            , form = layui.form
            , layer = layui.layer;
        const selectProvince = $("#provinceName");
        const selectContinents = $("#continents");

        // 加载表格数据
        function initialTable() {
            table.render({
                elem: '#foreignStatistics'
                /* 高度最大化 */
                , height: 500
                /* 全局设置单元格的最新宽度 */
                , cellMinWidth: 60
                , title: '国外疫情表'
                , url: '/crawler/getForeignStatistics'
                , cols: [
                    [{field: 'locationId', hide: true}
                        , {field: 'continents', title: '大洲'}
                        , {field: 'provinceName', title: '国家名称'}
                        , {field: 'countryShortCode', title: '英文简称'}
                        , {field: 'countryFullName', title: '英文全称'}
                        , {field: 'currentConfirmedCount', title: '当前确诊', sort: true}
                        , {field: 'confirmedCount', title: '累计确诊', sort: true}
                        , {field: 'suspectedCount', title: '疑似病例'}
                        , {field: 'curedCount', title: '治愈病例'}
                        , {field: 'deadCount', title: '死亡病例'}
                        , {field: 'deadRate', title: '死亡率%', sort: true}
                        , {title: '操作', fixed: 'right', align: 'center', toolbar: '#toolbar'}
                    ]
                ]
                , page: {
                    layout: ['prev', 'page', 'next', 'skip', 'limit', 'refresh', 'count'] //自定义分页布局
                    , groups: 5 //显示 5 个连续页码
                    , first: '首页' // 自定义“首页”的内容
                    , last: '尾页' // 自定义“尾页”的内容
                    , limit: 20 // 每页显示条数
                    , limits: [20, 50, 100, 200] //每页条数的选择项
                }
                , where: {
                    'continents': ''
                    , 'provinceName': ''
                    // 排序相关字段
                    , field : ''
                    , order : ''
                }
                , autoSort : false // 自定义排序，必须添加的内容
                , method: 'post'
                , response: {
                    statusCode: 200 // 重新规定成功的状态码为 200， table 默认为0
                }
                , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.data.total, //解析数据长度
                        "data": res.data.rows //解析数据列表
                    };
                }
            });
        }

        initialTable();

        // 获取大洲下拉框
        function getContinents() {
            selectContinents.empty('');
            $.ajax({
                url: '/crawler/getContinents'
                , dataType: 'json'
                , type: 'get'
                , success: function (data) {
                    selectContinents.append(new Option('请选择或搜索大洲', ''));
                    $.each(data.data, function (index, item) {
                        selectContinents.append(new Option(item, item));
                    });
                    // append 结束后重新渲染
                    form.render("select");
                }
            });
        }

        getContinents();

        // 获取国家下拉框
        form.on('select(continentsFilter)', function (data) {
            selectProvince.empty('');
            if (data.value !== '' && data.value != null) {
                $.ajax({
                    url: '/crawler/getCountries'
                    , dataType: 'json'
                    , data: {
                        continents: $('#continents').val()
                    }
                    , type: 'get'
                    , success: function (data) {
                        selectProvince.append(new Option('请选择或搜索国家', ''));
                        $.each(data.data, function (index, item) {
                            // new Option(text,value)
                            selectProvince.append(new Option(item, item));
                        });
                        selectProvince.find("option[value='']").prop("selected", true);
                        // append 结束后重新渲染
                        form.render("select");
                    }
                })
            }
        });

        // 搜索功能
        const active = {
            reload: function () {
                table.reload('foreignStatistics', {
                    where: {
                        'provinceName': selectProvince.val().trim()
                        , 'continents': selectContinents.val().trim()
                        // 排序相关的字段
                        , field : ''
                        , order : ''
                    }
                    , page: {
                        cur: 1
                    }
                }, 'data');
            }
        };
        $('#search_submit').on('click', function () {
            let type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        //重置按钮
        $("#searchResetBtn").unbind().bind({
            click: function () {
                getContinents();
                initialTable();
                selectProvince.empty('');
                selectProvince.append(new Option('请选择或搜索国家', ''));
                //加载完以后重新初始化
                $("#search_submit").click();
            }
        });

        // 手动刷新数据
        $('#refresh').unbind().bind({
            click: function () {
                const loading = layer.load(0, {shade: [0.5, 'grey'], time: 2 * 1000});
                $.ajax({
                    url: "/crawler/refresh"
                    , success: function (data) {
                        if (data.code === 200) {
                            layer.close(loading);
                            layer.msg("数据刷新成功！", {icon: 6});
                            getContinents();
                            initialTable();
                            selectProvince.empty('');
                            selectProvince.append(new Option('请选择或搜索国家', ''));
                        }
                    }
                });
            }
        });

        // 自定义排序
        table.on('sort(foreignStatic)',function (obj) { // foreignStatic 对应的是table的lay-filter
            table.reload('foreignStatistics',{
                initSort: obj
                , where: {
                    'provinceName': selectProvince.val().trim()
                    , 'continents': selectContinents.val().trim()
                    // 排序相关字段
                    , field : obj.field // 排序的字段
                    , order : obj.type // 排序的方式,当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
                }
            }); // foreignStatistics 对应的是table的id
        });
    });
</script>
</html>